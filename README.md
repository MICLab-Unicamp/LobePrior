# Deep learning with probabilistic models for segmenting lung lobes on computed tomography images with severe abnormalities

Project developed for XXIX Congresso Brasileiro de Engenharia Biomédica (CBEB) 2024 (https://sbeb.org.br/cbeb2024)

## Abstract

> The development of efficient and robust algorithms in automated tools for segmenting the lung and its lobes is useful for the diagnosis and monitoring of lung diseases that cause lung abnormalities, such as pneumonia caused by COVID-19 and cancerous nodules. The amount of available data containing manual annotations of the lobes in patients with severe lung abnormalities such as consolidations and ground glass opacities is scarce, due to the difficulty of visualizing the lobar fissures. This work aims to develop a method for automated segmentation of lung lobes using deep neural networks in computed tomography images of the lungs of patients with severe abnormalities. The method is based on probabilistic models built from labels fusion, used not only to guide the deep neural networks while learning to segment the lobes, but also for postprocessing the network prediction to obtain the final segmentation. Segmentation is performed in two stages: a coarse stage working on downsampled images and a second high-resolution stage, where specialized AttUNets compete for each lobe's segmentation. The performance of the proposed approach was assessed using two public datasets with lobe annotations, in the presence of cancer nodules and COVID-19 consolidations. Open source implementation is available at

# To install dependencies
> sh requirements.txt

# To run project
> python main.py

<!--
We present an approach using probabilistic models, constructed from lung CT images. The images were recorded and separated into groups, according to shape and appearance. The images were separated into groups because of the great difference between the shapes that the lung has between patients. Added to post-processing and templates, a model capable of segmenting CT images of lungs affected by severe diseases was developed. The main contribution of this work was to improve the quality of these segmentations and present a model capable of identifying lobar fissures more efficiently, as this is a task considered very difficult, overcoming the difficulty of the methods in finding the fissures correctly, as they are healthy. deformed by lung diseases such as cancer and COVID-19.
-->

# Data

The data required to run the project can be downloaded from the link below.

[Download dos dados](https://github.com/MICLab-Unicamp/LobePrior/releases/download/LobePrior/dados.zip)

# Project

   * This work was accepted in CBEB 2024 (https://sbeb.org.br/cbeb2024).

   <div align="center">
	<figure>
	    <img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/Lobes_coronacases_001_com_fundo_branco.png", alt="Unet",  width="200", height="auto">
	</figure>
   </div>

* Diagram of the method implemented using CCN and a priori information, incorporated into the network input as probabilistic models:

     <div align="center">
	<figure>
	    <img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/Network_final_post_new.png" alt="LobePrior", width="800", height="auto" >
	</figure>
     </div>


* Segmentations using the LobePrior, nnUnet and LungMask methods on the CT image coronacases_007 (slice 150), from the Coronacases[1] dataset. Here, it is possible to visualize the segmentation errors (rectangular region) generated by each of the networks, in relation to the \textit{gold standard} (Fig. b):

   <div align="center">
	<figure>
	    <img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/coronacases_007/coronacases_007_150_ct.png" alt="CT image", height="200" width="200">
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/coronacases_007/coronacases_007_150_gt.png" alt="Ground Truth", height="200" width="200"></td>
		<br>CT image and Ground Truth<br>
	</figure/figure>

	<br>

	<figure>
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/coronacases_007/coronacases_007_150_LobePrior.png" alt="LobePrior (0,953)", height="200" width="200">
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/coronacases_007/coronacases_007_150_nnunet.png" alt="nnUnet (0,943)", height="200" width="200">
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/coronacases_007/coronacases_007_150_LTRCLobes_R231.png" alt="LungMask (0,945)", height="200" width="200">
		<br>LobePrior (Dice score = 0.979), nnUnet (Dice score = 0.943) and Lungmask (Dice score = 0.945)<br>
	</figure>
   </div>


* Qualitative evaluation using 3D representations in CT images of lungs from patients with severe injuries:

   <div align="center">
	<figure>
	    <img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/Cbeb_images.png" alt="Unet", height="300" width="600">
	</figure>
   </div>

* Qualitative evaluation using 3D representations in CT images of lungs from patients with severe injuries:

   <div align="center">
	<figure>
	    <img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/Cbeb_volumes.png" alt="Unet", height="300" width="600">
	</figure>
   </div>



<div align="center">
	<figure>
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/gifs/coronacases_010_lobeprior.gif" alt="LobePrior", style="width: 50%;">
		<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/gifs/coronacases_010_lungmask.gif" alt="Lungmask", style="width: 50%;">
	    	<img src="https://github.com/MICLab-Unicamp/LobePrior/blob/main/images/gifs/coronacases_010_nnUnet.gif" alt="nnUnet", style="width: 50%;">
	</figure>
</div>

<!--
Outputs for LobePrior       |  Outputs for nnUnet    |  Outputs for Lungmask
:-------------------------:|:-------------------------:
![LobePrior](images/gifs/coronacases_010_lobeprior.gif)  |
![nnUnet](images/gifs/coronacases_010_nnUnet.gif)   |
![Lungmask](images/gifs/coronacases_010_lungmask.gif)
-->


## Citation

``` 
@DATASET{redu_ORXJKS_2025,
	author = {Jean Antonio Ribeiro and Leticia Rittner and Diedre Santos do Carmo and Simone Appenzeller and Ricardo Siufi Magalhães and Sergio San Juan Dertkigil and Fabiano Reis},
	publisher = {Repositório de Dados de Pesquisa da Unicamp},
	title = {{LOCCA: Manual annotations for lung lobes in CT images of patients with cancer and COVID-19}},
	year = {2025},
	version = {V1},
	doi = {10.25824/redu/ORXJKS},
	url = {https://doi.org/10.25824/redu/ORXJKS}
}

@ARTICLE{CBEB2024,
	title = {Deep learning with probabilistic models for segmenting lung lobes on computed tomography images with severe abnormalities},
	journal = {CBEB 2024},
	pages = {1-6},
	year = {2024},
	author = {Jean Antonio Ribeiro and Diedre Santos do Carmo and Fabiano Reis and Leticia Rittner}
}

@ARTICLE{review2022,
	title = {{A Systematic Review of Automated Segmentation Methods and Public Datasets for the Lung and its Lobes and Findings on Computed Tomography Images}},
	author={Diedre Santos do Carmo and Jean Antonio Ribeiro and Sergio Dertkigil and Simone Appenzeller and Roberto Lotufo and Leticia Rittner},
	journal={Yearbook of Medical Informatics},
	volume={31},
	number={01},
	pages={277-295},
	year={2022},
	doi = {10.1055/s-0042-1742517}
}
```
